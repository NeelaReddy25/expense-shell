#!/bin/bash

# Define the path to the Nginx configuration file
NGINX_CONF="/etc/nginx/nginx.conf"

# Define the new log format
NEW_LOG_FORMAT='log_format main '\''$remote_addr [$time_local] $request $status $body_bytes_sent "$http_referer" $request_time''

# Backup the existing configuration file
cp "$NGINX_CONF" "$NGINX_CONF.bak"

# Update the log format in the configuration file
sed -i "/^log_format main/c\\$NEW_LOG_FORMAT" "$NGINX_CONF"

# Test the Nginx configuration for syntax errors
if nginx -t; then
    # Reload Nginx to apply the changes
    systemctl reload nginx
    echo "Nginx log format updated and reloaded successfully."
else
    echo "Nginx configuration test failed. Please check the configuration file."
fi